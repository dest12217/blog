---
title: '画像投稿フォームを作る'
timestamp: '2020/12/25'
tags:
  - 'JavaScript'
  - 'HTML'
---

この記事は[JavaScript Advent Calendar 2020](https://qiita.com/advent-calendar/2020/javascript)の25日目になります。

レビューサイトのように、ユーザーが画像ファイルをそれぞれがアップロードし、投稿するウェブサイトを作るとき、必ず用いられるのが`<input type="file">`によるアップロードである。

ファイルのアップロードといえば、データベースを始めとしたバックエンド技術が主役のように捉えられがちだ。しかし、取得した画像ファイルを再描写することによるサムネイルの生成や、画像ファイルを予め加工してから送信して軽量化を図るなど、JavaScriptの出番も少なくない。 

実際に`<input type="file">`を取り扱い、いくつかハマりやすいと感じたポイントがあったので、この場を借りてまとめていくこととする。

## 1. `<input type="file">`の`value`は、画像データではない

`<input type="file">`で画像をアップし、そのvalueを確認すると、値は`C:/fakepath/...`となっており、画像データではなかった。  
取得した画像データは`value`ではなく、`files`の中に配列で格納される。

画像

`<input type="file">`の`value`にはアクセス制約あるため、取得した画像ファイルのフルパスは取得することができず、「C:/fakepath/」などのダミーになる。  
「C:/fakepath/」に対応する部分はブラウザによって異なり、取得されるパスの形式も様々である。もし、ファイル名をページ上に表示させる画面を作りたいのであれば、ファイル名の取得には、`value`ではなく`file.name`を用いたほうがよいだろう。

同じくセキュリティの観点から、`value`そのものを修正することも禁止されている。  

## 2. `<input type="file">`で取得した画像データは、置き換えできない

`files`には`File`コンストラクタが`FileList`という名の配列になって格納されている。 

画像

`File`は、`new File()`とすることで生成することができるため、一見上書きが可能なように見える。

しかし、`files`を故意に`File`で上書きしようとすると失敗した。

エラー画像

これも、`<input type="file">`のセキュリティによる問題である。  
画像圧縮などでどうしてもデータを更新したいというときには、画像をbase64に変換し、`<input type="hidden">`など別のパーツにデータを保持させれば解決できる。

`<input type="file">`に残っている元の画像データは、送信されないように削除しておくことを忘れずに。

また、データが挿入できるということは、改竄もできるということだ。  
`value`の中身が改竄されたり、意図していないデータが送信されるリスクが存在するため、バックエンド側でのバリデーションや送信できるデータのサイズ制限は必須となる。  

## まとめ

フォーム関連パーツのHTMLとJavaScriptはなかなか融通が聞かないことが多い印象。  
しかし、それを脳筋に解決するのではなく、仕様をしっかり読み解くことが大事。
